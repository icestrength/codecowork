<div id="vid-box"></div>
<div id="vid-thumb"></div>

<form name="loginForm" id="login" action="#" onsubmit="return login(this);">
  <input type="text" name="username" id="username" placeholder="Pick a username!" />
  <input type="submit" name="login_submit" value="Log In">
</form>


<form name="callForm" id="call" action="#" onsubmit="return makeCall(this);">
  <input type="text" name="number" placeholder="Enter user to dial!" />
  <input type="submit" value="Call" />
</form>

<div id="inCall">
  <!-- Buttons for in call features -->
  <button id="end" onclick="end()">End</button> <button id="mute" onclick="mute()">Mute</button> <button id="pause" onclick="pause()">Pause</button>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdn.pubnub.com/pubnub-3.7.14.min.js"></script>
<script src="https://cdn.pubnub.com/webrtc/webrtc.js"></script>
<script src="https://cdn.pubnub.com/webrtc/rtc-controller.js"></script>
<script>
  var video_out = document.getElementById("vid-box");
  var vid_thumb = document.getElementById("vid-thumb");

  function login(form) {
    var phone = window.phone = PHONE({
      number: form.username.value || "Anonymous", // listen on username line else Anonymous
      publish_key: 'pub-c-037b5e80-c23a-4c47-90d4-7135712e1e5e',
      subscribe_key: 'sub-c-936f958a-3581-11e8-9609-8e0b2828cd62',
      ssl: true
    });
    var ctrl = window.ctrl = CONTROLLER(phone);
    ctrl.ready(function() {
      form.username.style.background = "#55ff5b";
      form.login_submit.hidden = "true";
      ctrl.addLocalStream(vid_thumb);
      addLog("Logged in as " + form.username.value);
    });
    ctrl.receive(function(session) {
      session.connected(function(session) {
        video_out.appendChild(session.video);
        addLog(session.number + " has joined.");
        vidCount++;
      });
      session.ended(function(session) {
        ctrl.getVideoElement(session.number).remove();
        addLog(session.number + " has left.");
        vidCount--;
      });
    });
    ctrl.videoToggled(function(session, isEnabled) {
      ctrl.getVideoElement(session.number).toggle(isEnabled);
      addLog(session.number + ": video enabled - " + isEnabled);
    });
    ctrl.audioToggled(function(session, isEnabled) {
      ctrl.getVideoElement(session.number).css("opacity", isEnabled ? 1 : 0.75);
      addLog(session.number + ": audio enabled - " + isEnabled);
    });
    return false;
  }

  function makeCall(form) {
    if (!window.phone) alert("Login First!");
    var num = form.number.value;
    if (phone.number() == num) return false; // No calling yourself!
    ctrl.isOnline(num, function(isOn) {
      if (isOn) ctrl.dial(num);
      else alert("User if Offline");
    });
    return false;
  }

  function mute() {
    var audio = ctrl.toggleAudio();
    if (!audio) $("#mute").html("Unmute");
    else $("#mute").html("Mute");
  }

  function end() {
    ctrl.hangup();
  }

  function pause() {
    var video = ctrl.toggleVideo();
    if (!video) $('#pause').html('Unpause');
    else $('#pause').html('Pause');
  }

  function getVideo(number) {
    return $('*[data-number="' + number + '"]');
  }

  function addLog(log) {
    $('#logs').append("<p>" + log + "</p>");
  }
</script>
